<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOZ VISIBLE: Cámara en Tiempo Real</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <i class="fas fa-hands"></i> VOZ VISIBLE
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link">Inicio</a>
                <a href="/#about" class="nav-link">Sobre Nosotros</a>
                <a href="/#learn" class="nav-link">Aprende Más</a>
                <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()" title="Cambiar tema">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top: 80px;">
        <header class="header">
            <h1><i class="fas fa-video"></i> Cámara en Tiempo Real</h1>
            <p>Reconocimiento de lenguaje de señas colombiano desde tu cámara</p>
            <div id="systemStatus" class="system-status">
                <i class="fas fa-spinner fa-spin"></i> Verificando sistema...
            </div>
        </header>

        <main class="main-content">
            <div class="camera-container">
                <div class="video-container">
                    <video id="cameraVideo" autoplay muted playsinline></video>
                    <canvas id="landmarksCanvas" style="position: absolute; top: 0; left: 0; pointer-events: none;"></canvas>
                    <canvas id="captureCanvas" style="display: none;"></canvas>
                    <div id="cameraPlaceholder" class="camera-placeholder">
                        <i class="fas fa-video"></i>
                        <h3>Cámara Web</h3>
                        <p>Haz clic en "Iniciar Cámara" para comenzar</p>
                    </div>
                </div>
                
                <div class="prediction-display">
                    <h3><i class="fas fa-brain"></i> Predicción en Tiempo Real</h3>
                    <div class="predicted-word" id="cameraPredictedWord">-</div>
                    <div class="confidence-bar">
                        <div class="confidence-fill" id="cameraConfidenceFill"></div>
                    </div>
                    <div class="confidence-text" id="cameraConfidenceText">0%</div>
                    <div class="tts-controls">
                        <div class="tts-indicator" id="cameraTTSIndicator" style="display: none;">
                            <i class="fas fa-volume-up tts-icon-animate"></i>
                            <span>Reproduciendo audio...</span>
                        </div>
                        <button class="btn btn-info btn-small" id="cameraRepeatAudioBtn" onclick="repeatLastAudio()" style="display: none;" title="Repetir audio">
                            <i class="fas fa-redo"></i> Repetir Audio
                        </button>
                    </div>
                    <div class="fps-counter">
                        FPS: <span id="fpsCounter">0</span>
                    </div>
                </div>
            </div>

            <div class="controls">
                <button id="startCameraBtn" onclick="startCamera()" class="btn btn-primary">
                    <i class="fas fa-play"></i> Iniciar Cámara
                </button>
                <button id="stopCameraBtn" onclick="stopCamera()" class="btn btn-secondary" disabled>
                    <i class="fas fa-stop"></i> Detener Cámara
                </button>
                <button onclick="togglePrediction()" class="btn btn-info">
                    <i class="fas fa-brain"></i> Toggle Predicción
                </button>
                <button id="toggleLandmarksBtn" onclick="toggleLandmarks()" class="btn btn-secondary">
                    <i class="fas fa-draw-polygon"></i> <span id="landmarksBtnText">Mostrar Landmarks</span>
                </button>
                <button onclick="captureImage()" class="btn btn-success">
                    <i class="fas fa-camera"></i> Capturar
                </button>
                <a href="/" class="btn btn-secondary">
                    <i class="fas fa-home"></i> Volver al Inicio
                </a>
            </div>

            <div class="stats-panel">
                <div class="stat-item">
                    <span class="stat-label">Estado:</span>
                    <span id="connectionStatus" class="stat-value">Desconectado</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Predicciones:</span>
                    <span id="predictionCount" class="stat-value">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Última actualización:</span>
                    <span id="lastUpdate" class="stat-value">-</span>
                </div>
            </div>

            <div class="history-panel">
                <div class="history-header">
                    <h3><i class="fas fa-history"></i> Historial de Predicciones</h3>
                    <button class="btn btn-secondary btn-small" onclick="clearPredictionHistory()">
                        <i class="fas fa-trash"></i> Limpiar
                    </button>
                </div>
                <ul id="predictionHistoryList" class="history-list">
                    <li class="history-empty">Aún no hay predicciones</li>
                </ul>
            </div>
        </main>

        <footer class="footer-main">
            <div class="container">
                <div class="footer-content">
                    <div class="footer-section">
                        <h3><i class="fas fa-hands"></i> VOZ VISIBLE</h3>
                        <p>
                            Tecnología de traducción de lengua de señas colombiana 
                            desarrollada por estudiantes para la comunidad sorda.
                        </p>
                    </div>

                    <div class="footer-section">
                        <h4>Enlaces</h4>
                        <ul class="footer-links">
                            <li><a href="/">Inicio</a></li>
                            <li><a href="/#about">Sobre Nosotros</a></li>
                            <li><a href="/#learn">Aprende Más</a></li>
                            <li><a href="/#demo">Probar Demo</a></li>
                        </ul>
                    </div>

                    <div class="footer-section">
                        <h4>Contacto</h4>
                        <ul class="footer-links">
                            <li>
                                <a href="mailto:tomasgonzalez0411@gmail.com">
                                    <i class="fas fa-envelope"></i> tomasgonzalez0411@gmail.com
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com" target="_blank">
                                    <i class="fab fa-github"></i> GitHub
                                </a>
                            </li>
                        </ul>
                    </div>

                    <div class="footer-section">
                        <h4>Proyecto</h4>
                        <p class="footer-disclaimer">
                            <i class="fas fa-info-circle"></i> 
                            Desarrollado por Tomás González y equipo Voz Visible.<br>
                            Uso educativo y sin fines de lucro.
                        </p>
                    </div>
                </div>

                <div class="footer-bottom">
                    <p>&copy; 2024 VOZ VISIBLE - Reconocimiento de Lenguaje de Señas Colombiano</p>
                    <p class="footer-credit">
                        Colegio José Elías Puyana - Jornada Sabatina
                    </p>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Variables globales
        let socket;
        let cameraStream = null;
        let isCapturing = false;
        let isPredictionEnabled = true;
        let showLandmarks = false;
        let predictionCount = 0;
        let lastFrameTime = 0;
        let fps = 0;
        let lastAudioData = null;
        let currentAudio = null;
        const MAX_HISTORY_ITEMS = 12;
        const predictionHistory = [];

        // Inicializar aplicación
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            checkSystemStatus();
            // Cargar preferencia de landmarks desde localStorage
            showLandmarks = localStorage.getItem('showLandmarks') === 'true';
            updateLandmarksToggle();
            // Inicializar tema
            initializeTheme();
        });

        // Inicializar Socket.IO
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Conectado al servidor');
                updateConnectionStatus('Conectado', 'connected');
            });
            
            socket.on('disconnect', function() {
                console.log('Desconectado del servidor');
                updateConnectionStatus('Desconectado', 'disconnected');
            });
            
            socket.on('status', function(data) {
                updateSystemStatus(data.status, data.message);
            });
            
            socket.on('prediction', function(data) {
                if (data.status === 'success') {
                    updateCameraPrediction(data.word, data.confidence);
                    predictionCount++;
                    updateStats();
                    addPredictionToHistory({
                        word: data.word,
                        confidence: data.confidence,
                        timestamp: data.timestamp
                    });
                    
                    // Dibujar landmarks si están disponibles y están activados
                    if (data.landmarks && showLandmarks) {
                        drawLandmarks(data.landmarks);
                    }
                    
                    // Reproducir audio TTS si está disponible
                    if (data.audio) {
                        playTTSAudio(data.audio);
                    }
                } else {
                    console.error('Error en predicción:', data.message);
                }
            });
            
            socket.on('camera_status', function(data) {
                console.log('Estado de cámara:', data.message);
            });
        }

        // Verificar estado del sistema
        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                updateSystemStatus(data.status, data.message);
            } catch (error) {
                updateSystemStatus('error', 'Error de conexión');
            }
        }

        // Iniciar cámara
        async function startCamera() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: 640, 
                        height: 480,
                        facingMode: 'user'
                    } 
                });
                
                const video = document.getElementById('cameraVideo');
                const placeholder = document.getElementById('cameraPlaceholder');
                
                video.srcObject = cameraStream;
                video.style.display = 'block';
                placeholder.style.display = 'none';
                
                // Habilitar controles
                document.getElementById('startCameraBtn').disabled = true;
                document.getElementById('stopCameraBtn').disabled = false;
                
                // Iniciar captura de frames
                isCapturing = true;
                socket.emit('start_camera');
                captureFrames();
                
                console.log('Cámara iniciada correctamente');
                
            } catch (error) {
                console.error('Error accediendo a la cámara:', error);
                alert('Error: No se pudo acceder a la cámara. Asegúrate de dar permisos.');
            }
        }

        // Detener cámara
        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            const video = document.getElementById('cameraVideo');
            const placeholder = document.getElementById('cameraPlaceholder');
            
            video.style.display = 'none';
            placeholder.style.display = 'block';
            
            // Deshabilitar controles
            document.getElementById('startCameraBtn').disabled = false;
            document.getElementById('stopCameraBtn').disabled = true;
            
            isCapturing = false;
            socket.emit('stop_camera');
            
            console.log('Cámara detenida');
        }

        // Capturar frames para predicción
        function captureFrames() {
            if (!isCapturing || !isPredictionEnabled) {
                if (isCapturing) {
                    requestAnimationFrame(captureFrames);
                }
                return;
            }
            
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('captureCanvas');
            const ctx = canvas.getContext('2d');
            
            // Configurar canvas
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;
            
            // Dibujar frame actual
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convertir a base64
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Enviar frame al servidor (cada 200ms para no saturar)
            const currentTime = Date.now();
            if (currentTime - lastFrameTime > 200) {
                socket.emit('process_frame', { 
                    frame: imageData,
                    include_landmarks: showLandmarks
                });
                lastFrameTime = currentTime;
                
                // Calcular FPS
                fps = Math.round(1000 / (currentTime - lastFrameTime + 200));
                document.getElementById('fpsCounter').textContent = fps;
            }
            
            // Ajustar tamaño del canvas de landmarks si está visible
            if (showLandmarks) {
                const landmarksCanvas = document.getElementById('landmarksCanvas');
                landmarksCanvas.width = video.videoWidth || 640;
                landmarksCanvas.height = video.videoHeight || 480;
            }
            
            // Continuar capturando
            requestAnimationFrame(captureFrames);
        }

        // Toggle predicción
        function togglePrediction() {
            isPredictionEnabled = !isPredictionEnabled;
            const btn = event.target;
            if (isPredictionEnabled) {
                btn.innerHTML = '<i class="fas fa-brain"></i> Detener Predicción';
                btn.className = 'btn btn-warning';
            } else {
                btn.innerHTML = '<i class="fas fa-brain"></i> Iniciar Predicción';
                btn.className = 'btn btn-info';
            }
        }

        // Capturar imagen
        function captureImage() {
            if (!cameraStream) return;
            
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('captureCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Descargar imagen
            const link = document.createElement('a');
            link.download = `voz-visible-capture-${Date.now()}.jpg`;
            link.href = canvas.toDataURL('image/jpeg', 0.9);
            link.click();
        }

        // Historial de predicciones
        function addPredictionToHistory(entry) {
            const newEntry = {
                word: entry.word || '-',
                confidence: typeof entry.confidence === 'number' ? entry.confidence : 0,
                timestamp: entry.timestamp || Date.now() / 1000
            };
            predictionHistory.unshift(newEntry);
            if (predictionHistory.length > MAX_HISTORY_ITEMS) {
                predictionHistory.pop();
            }
            renderPredictionHistory();
        }

        function renderPredictionHistory() {
            const list = document.getElementById('predictionHistoryList');
            list.innerHTML = '';

            if (!predictionHistory.length) {
                list.innerHTML = '<li class="history-empty">Aún no hay predicciones</li>';
                return;
            }

            predictionHistory.forEach(item => {
                const li = document.createElement('li');
                li.className = 'history-item';
                li.innerHTML = `
                    <div class="history-word">${item.word}</div>
                    <div class="history-meta">
                        <div>${formatConfidence(item.confidence)}</div>
                        <small>${formatTimestamp(item.timestamp)}</small>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        function clearPredictionHistory() {
            predictionHistory.length = 0;
            renderPredictionHistory();
        }

        function formatConfidence(confidence) {
            const percent = Math.round(confidence * 100);
            return `${percent}% confianza`;
        }

        function formatTimestamp(timestamp) {
            const date = new Date(typeof timestamp === 'number' && timestamp < 1e12 ? timestamp * 1000 : timestamp);
            return date.toLocaleTimeString();
        }

        // Toggle visualización de landmarks
        function toggleLandmarks() {
            showLandmarks = !showLandmarks;
            localStorage.setItem('showLandmarks', showLandmarks.toString());
            updateLandmarksToggle();
            
            // Limpiar canvas si se desactiva
            if (!showLandmarks) {
                const landmarksCanvas = document.getElementById('landmarksCanvas');
                const ctx = landmarksCanvas.getContext('2d');
                ctx.clearRect(0, 0, landmarksCanvas.width, landmarksCanvas.height);
            }
        }
        
        // Actualizar UI del toggle de landmarks
        function updateLandmarksToggle() {
            const btn = document.getElementById('toggleLandmarksBtn');
            const text = document.getElementById('landmarksBtnText');
            const landmarksCanvas = document.getElementById('landmarksCanvas');
            
            if (showLandmarks) {
                btn.className = 'btn btn-success';
                text.textContent = 'Ocultar Landmarks';
                landmarksCanvas.style.display = 'block';
            } else {
                btn.className = 'btn btn-secondary';
                text.textContent = 'Mostrar Landmarks';
                landmarksCanvas.style.display = 'none';
            }
        }
        
        // Dibujar landmarks en el canvas
        function drawLandmarks(landmarks) {
            const canvas = document.getElementById('landmarksCanvas');
            const ctx = canvas.getContext('2d');
            const video = document.getElementById('cameraVideo');
            
            // Limpiar canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Asegurar que el canvas tenga el tamaño correcto
            if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
                canvas.width = video.videoWidth || 640;
                canvas.height = video.videoHeight || 480;
            }
            
            const width = canvas.width;
            const height = canvas.height;
            
            // Dibujar landmarks de pose (cuerpo)
            if (landmarks.pose && landmarks.pose.length > 0) {
                ctx.strokeStyle = '#00ff00';
                ctx.fillStyle = '#00ff00';
                ctx.lineWidth = 2;
                
                landmarks.pose.forEach((point, index) => {
                    if (point.visibility > 0.5) {
                        const x = point.x * width;
                        const y = point.y * height;
                        ctx.beginPath();
                        ctx.arc(x, y, 3, 0, 2 * Math.PI);
                        ctx.fill();
                    }
                });
            }
            
            // Dibujar landmarks de mano derecha
            if (landmarks.right_hand && landmarks.right_hand.length > 0) {
                ctx.strokeStyle = '#ff0000';
                ctx.fillStyle = '#ff0000';
                ctx.lineWidth = 2;
                
                // Dibujar puntos
                landmarks.right_hand.forEach((point) => {
                    const x = point.x * width;
                    const y = point.y * height;
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, 2 * Math.PI);
                    ctx.fill();
                });
                
                // Conectar puntos de la mano (simplificado)
                if (landmarks.right_hand.length >= 5) {
                    ctx.beginPath();
                    ctx.moveTo(landmarks.right_hand[0].x * width, landmarks.right_hand[0].y * height);
                    for (let i = 1; i < 5; i++) {
                        ctx.lineTo(landmarks.right_hand[i].x * width, landmarks.right_hand[i].y * height);
                    }
                    ctx.stroke();
                }
            }
            
            // Dibujar landmarks de mano izquierda
            if (landmarks.left_hand && landmarks.left_hand.length > 0) {
                ctx.strokeStyle = '#0000ff';
                ctx.fillStyle = '#0000ff';
                ctx.lineWidth = 2;
                
                // Dibujar puntos
                landmarks.left_hand.forEach((point) => {
                    const x = point.x * width;
                    const y = point.y * height;
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, 2 * Math.PI);
                    ctx.fill();
                });
                
                // Conectar puntos de la mano (simplificado)
                if (landmarks.left_hand.length >= 5) {
                    ctx.beginPath();
                    ctx.moveTo(landmarks.left_hand[0].x * width, landmarks.left_hand[0].y * height);
                    for (let i = 1; i < 5; i++) {
                        ctx.lineTo(landmarks.left_hand[i].x * width, landmarks.left_hand[i].y * height);
                    }
                    ctx.stroke();
                }
            }
        }
        
        // Reproducir audio TTS con feedback visual
        function playTTSAudio(audioData) {
            if (!audioData) return;
            
            // Guardar último audio para repetir
            lastAudioData = audioData;
            
            // Mostrar indicador de TTS
            const ttsIndicator = document.getElementById('cameraTTSIndicator');
            const repeatBtn = document.getElementById('cameraRepeatAudioBtn');
            
            if (ttsIndicator) {
                ttsIndicator.style.display = 'flex';
            }
            if (repeatBtn) {
                repeatBtn.style.display = 'inline-block';
            }
            
            try {
                // Detener audio anterior si está reproduciéndose
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                }
                
                currentAudio = new Audio(audioData);
                
                // Ocultar indicador cuando termine
                currentAudio.addEventListener('ended', function() {
                    if (ttsIndicator) {
                        ttsIndicator.style.display = 'none';
                    }
                });
                
                // Manejar errores
                currentAudio.addEventListener('error', function(e) {
                    console.warn('Error reproduciendo audio:', e);
                    if (ttsIndicator) {
                        ttsIndicator.style.display = 'none';
                    }
                });
                
                currentAudio.play().catch(error => {
                    console.warn('Error reproduciendo audio:', error);
                    if (ttsIndicator) {
                        ttsIndicator.style.display = 'none';
                    }
                });
            } catch (error) {
                console.warn('Error creando audio:', error);
                if (ttsIndicator) {
                    ttsIndicator.style.display = 'none';
                }
            }
        }
        
        // Repetir último audio reproducido
        function repeatLastAudio() {
            if (lastAudioData) {
                playTTSAudio(lastAudioData);
            }
        }

        // Actualizar predicción de cámara
        function updateCameraPrediction(word, confidence) {
            const predictedWord = document.getElementById('cameraPredictedWord');
            const confidenceFill = document.getElementById('cameraConfidenceFill');
            const confidenceText = document.getElementById('cameraConfidenceText');
            
            predictedWord.textContent = word;
            
            const confidencePercent = Math.round(confidence * 100);
            confidenceFill.style.width = confidencePercent + '%';
            confidenceText.textContent = confidencePercent + '%';
            
            // Color según confianza
            if (confidence > 0.8) {
                confidenceFill.className = 'confidence-fill high';
            } else if (confidence > 0.5) {
                confidenceFill.className = 'confidence-fill medium';
            } else {
                confidenceFill.className = 'confidence-fill low';
            }
        }

        // Actualizar estado del sistema
        function updateSystemStatus(status, message) {
            const statusElement = document.getElementById('systemStatus');
            
            statusElement.innerHTML = `<i class="fas fa-${getStatusIcon(status)}"></i> ${message}`;
            statusElement.className = `system-status ${status}`;
        }

        // Actualizar estado de conexión
        function updateConnectionStatus(status, className) {
            const connectionStatus = document.getElementById('connectionStatus');
            connectionStatus.textContent = status;
            connectionStatus.className = `stat-value ${className}`;
        }

        // Actualizar estadísticas
        function updateStats() {
            document.getElementById('predictionCount').textContent = predictionCount;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // Obtener icono según estado
        function getStatusIcon(status) {
            const icons = {
                'ready': 'check-circle',
                'error': 'exclamation-triangle',
                'initializing': 'spinner fa-spin',
                'missing_files': 'times-circle'
            };
            return icons[status] || 'question-circle';
        }

        // Gestión de tema (modo claro/oscuro)
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        }

        function applyTheme(theme) {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            
            if (theme === 'dark') {
                body.classList.add('dark-theme');
                if (themeIcon) {
                    themeIcon.className = 'fas fa-sun';
                }
            } else {
                body.classList.remove('dark-theme');
                if (themeIcon) {
                    themeIcon.className = 'fas fa-moon';
                }
            }
        }

        // Limpiar recursos al cerrar
        window.addEventListener('beforeunload', function() {
            if (cameraStream) {
                stopCamera();
            }
            if (socket) {
                socket.disconnect();
            }
        });
    </script>
</body>
</html>